/**
 * Create internal links to zotonic pages in the body text, by using the typeahead.
 *
 * @author Arjan Scherpenisse <arjan@scherpenisse.net>
 * @copyright 2010 Arjan Scherpenisse <arjan@scherpenisse.net>
 */

tinymce.PluginManager.requireLangPack('zlink');

tinymce.PluginManager.add('zlink', function(editor, url) {

    const showLinkDialog = function() {
        window.z_zlink = function(url, title) {
            let linkAttrs = {
                    href: url,
                    title: title
                },
                dom = editor.dom,
                selection = editor.selection;
            if (selection.getContent()) {
                editor.execCommand('mceInsertLink', false, linkAttrs);
            } else {
                editor.insertContent(dom.createHTML('a', linkAttrs, dom.encode(title)));
            }
        }
        const element = editor.getElement();
        let rsc_id = $(element).attr("data-id");
        if (!rsc_id) {
            rsc_id = $(element).closest("form").attr("data-id");
        }
        z_event('zlink', {
            rsc_id: rsc_id,
            language: window.zEditLanguage()
        });
    };

    // Add a button to the button bar
     editor.ui.registry.addButton('zlink', {
        title: 'Insert an internal link',
        icon: 'link',
        tooltip: 'Insert an internal link',
        onAction: showLinkDialog,
    });

    // Add a menu item to the tools menu
    editor.ui.registry.addMenuItem('zlink', {
        icon: 'link',
        text: 'Insert internal link',
        tooltip: 'Insert an internal link',
        context: 'format',
        onAction: showLinkDialog
    });
});