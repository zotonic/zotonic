#!/usr/bin/env sh

if [ -z "${ZOTONIC}" ]; then
   readonly ZOTONIC=${ZOTONIC:=$(\cd `dirname -- "$0"`/../../..;\pwd)}
   export ZOTONIC
fi
# Protect PATH and ZOTONIC environment variables to be changed at runtime
readonly PATH
for var in $(\env | \grep ZOTONIC_ | \cut -d '=' -f 1)
do
    readonly "${var}"
    export "${var}"
done
readonly ZOTONIC_BIN=$(\cd `\dirname -- "$0"`;\pwd)
export ZOTONIC_BIN

cd -- "${ZOTONIC}" || \exit 1

case "$1" in
    completion)
        COMMAND_NAMES="$(${ZOTONIC_BIN}/zotonic.escript command_names)"
        # TODO: Check OS (this works in Ubuntu 21.10)
        SYS_COMPLETION_DIR="/etc/bash_completion.d"
        OUTPUT="$SYS_COMPLETION_DIR/zotonic-completion.bash"
        # TODO: Completion for options
        sudo sh -c "printf '#/usr/bin/env bash\n\n_zotonic_completions()\n{\n\tif [ \"\${#COMP_WORDS[@]}\" != \"2\" ]; then\n\t\treturn\n\tfi\n\n\tCOMPREPLY=(\$(compgen -W %s \"\${COMP_WORDS[1]}\"))\n}\n\ncomplete -F _zotonic_completions zotonic' '$COMMAND_NAMES' >| '$OUTPUT'"
        sudo bash -c "source $OUTPUT"
        ;;
    start)
        CMD="$(${ZOTONIC_BIN}/zotonic.escript start)"
        eval ${CMD}
        ${ZOTONIC_BIN}/zotonic.escript wait
        ;;
    start_nodaemon|start-nodaemon)
        CMD="$(${ZOTONIC_BIN}/zotonic.escript start_nodaemon)"
        eval ${CMD}
        ;;
    shell)
        CMD="$(${ZOTONIC_BIN}/zotonic.escript shell)"
        eval ${CMD}
        ;;
    debug)
        CMD="$(${ZOTONIC_BIN}/zotonic.escript debug)"
        eval ${CMD}
        ;;
    runtests)
        export ZOTONIC_PORT=8040
        export ZOTONIC_LISTEN_PORT=8040
        export ZOTONIC_SSL_PORT=8043
        export ZOTONIC_SSL_LISTEN_PORT=8043
        export ZOTONIC_SMTP_BOUNCE_PORT=2535

        CMD="$(${ZOTONIC_BIN}/zotonic.escript runtests $@)"
        eval ${CMD}
        ;;
    stop)
        if [ -s "${ZOTONIC_PIDFILE}" ]; then
            readonly PID=$(\cat -- "${ZOTONIC_PIDFILE}")
        fi
        ${ZOTONIC_BIN}/zotonic.escript stop & 
        \wait $!    
        if [ ! -z "${PID}" ] && [ "${ZOTONIC_WAIT_VM:=0}" -eq "1" ]; then
            \printf "%s" "Waiting for VM stop "
            while \kill -0 ${PID} 2> /dev/null; do \printf "%s" "." ; \sleep 1; done;
            \printf "%s\n" " OK"
        fi
        ;;
    *)
        ${ZOTONIC_BIN}/zotonic.escript "$@"
        ;;
esac
